# API Integration Tests
# Builds Next.js in production mode, waits for readiness, tests Supabase API endpoints.

name: API Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: development
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Clear npm cache
        run: npm cache clean --force

      - name: Install dependencies
        run: |
          # Install with verbose logging; include optional deps so Next SWC binaries are available
          npm ci --include=dev --verbose > npm-install.log 2>&1 || (
            echo "‚ùå npm install failed. Showing install log:"
            cat npm-install.log
            exit 1
          )

      - name: Install wait-on globally
        run: npm install -g wait-on

      - name: Build
        env:
          NODE_ENV: production
        run: |
          npm run build --verbose || (
            echo "‚ùå Build failed. Showing npm install log for debugging:"
            cat npm-install.log
            exit 1
          )

      - name: Start Next.js production server in background
        env:
          NODE_ENV: production
        run: |
          # Build already run above; start the production server for stability in CI
          # Bind to localhost for more reliable connections
          NODE_ENV=production NEXT_TELEMETRY_DISABLED=1 DEBUG=* npm run start -- -p 3000 --hostname localhost > .next.log 2>&1 &
          echo "Started production server (background)"
          # Give process a moment to crash if it's going to
          sleep 5
          if ! ps aux | grep -v grep | grep "next start"; then
            echo "‚ùå Server crashed immediately:"
            cat .next.log
            exit 1
          fi

      - name: Wait for Next.js to be ready
        run: |
          echo "Waiting up to 300s for tcp:3000 (accept any HTTP status) ..."
          # Use TCP readiness instead of HTTP 2xx to avoid false negatives when root returns 404
          wait-on tcp:3000 --interval 2000 --timeout 300000 || (
            echo "‚ùå Server did not respond within 300s. Printing logs for debugging:"
            echo "---- .next.log ----"
            tail -n 200 .next.log || echo "No .next.log found"
            echo "---- .dev.log ----"
            tail -n 200 .dev.log || echo "No .dev.log found"
            exit 1
          )

      - name: Setup Auth & RBAC test users (admin, agent)
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_ANON: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üë• Creating admin and agent test users and obtaining tokens..."

          RUN_ID=${{ github.run_id }}
          ATTEMPT=${{ github.run_attempt }}
          ADMIN_EMAIL="admin-${RUN_ID}-${ATTEMPT}@ci.test"
          AGENT_EMAIL="agent-${RUN_ID}-${ATTEMPT}@ci.test"
          PASSWORD="P@ss-${RUN_ID}-${ATTEMPT}"

          create_user() {
            local EMAIL="$1"
            local PASSWORD="$2"
            RESP=$(curl -s -w "\n%{http_code}" -X POST "http://localhost:3000/api/auth/create-test-user" \
              -H "Content-Type: application/json" \
              -d "{\"email\":\"${EMAIL}\",\"password\":\"${PASSWORD}\"}")
            CODE=$(echo "$RESP" | tail -n1)
            BODY=$(echo "$RESP" | head -n-1)
            if [ "$CODE" != "201" ]; then
              echo "‚ùå Failed to create user ${EMAIL}, HTTP $CODE"
              echo "Response: $BODY"
              exit 1
            fi
            echo "$BODY"
          }

          get_token() {
            local EMAIL="$1"
            local PASSWORD="$2"
            TOKEN_RESP=$(curl -s -X POST "${SUPABASE_URL}/auth/v1/token?grant_type=password" \
              -H "apikey: ${SUPABASE_ANON}" \
              -H "Content-Type: application/json" \
              -d "{\"email\":\"${EMAIL}\",\"password\":\"${PASSWORD}\"}")
            # Extract access_token with sed to avoid jq dependency
            echo "$TOKEN_RESP" | sed -n 's/.*"access_token":"\([^"]*\)".*/\1/p'
          }

          set_role() {
            local USER_ID="$1"
            local ROLE="$2"
            ROLE_RESP=$(curl -s -w "\n%{http_code}" -X POST "${SUPABASE_URL}/rest/v1/user_roles?on_conflict=user_id" \
              -H "apikey: ${SUPABASE_SERVICE}" \
              -H "Authorization: Bearer ${SUPABASE_SERVICE}" \
              -H "Content-Type: application/json" \
              -H "Prefer: resolution=merge-duplicates,return=minimal" \
              -d "[{\"user_id\":\"${USER_ID}\",\"role\":\"${ROLE}\"}]")
            RC=$(echo "$ROLE_RESP" | tail -n1)
            if [ "$RC" != "201" ] && [ "$RC" != "204" ]; then
              echo "‚ùå Failed to set role ${ROLE} for user ${USER_ID}, HTTP $RC"
              echo "Response: $(echo "$ROLE_RESP" | head -n-1)"
              exit 1
            fi
          }

          echo "Creating admin user ${ADMIN_EMAIL}..."
          ADMIN_CREATE=$(create_user "$ADMIN_EMAIL" "$PASSWORD")
          ADMIN_ID=$(echo "$ADMIN_CREATE" | sed -n 's/.*"id":"\([^\"]*\)".*/\1/p')
          if [ -z "$ADMIN_ID" ]; then
            echo "‚ùå Could not parse admin user id"
            echo "$ADMIN_CREATE"
            exit 1
          fi
          set_role "$ADMIN_ID" "admin"
          ADMIN_TOKEN=$(get_token "$ADMIN_EMAIL" "$PASSWORD")
          if [ -z "$ADMIN_TOKEN" ]; then
            echo "‚ùå Failed to obtain admin access token"
            exit 1
          fi
          echo "ADMIN_TOKEN=$ADMIN_TOKEN" >> $GITHUB_ENV
          echo "ADMIN_ID=$ADMIN_ID" >> $GITHUB_ENV

          echo "Creating agent user ${AGENT_EMAIL}..."
          AGENT_CREATE=$(create_user "$AGENT_EMAIL" "$PASSWORD")
          AGENT_ID=$(echo "$AGENT_CREATE" | sed -n 's/.*"id":"\([^\"]*\)".*/\1/p')
          if [ -z "$AGENT_ID" ]; then
            echo "‚ùå Could not parse agent user id"
            echo "$AGENT_CREATE"
            exit 1
          fi
          set_role "$AGENT_ID" "agent"
          AGENT_TOKEN=$(get_token "$AGENT_EMAIL" "$PASSWORD")
          if [ -z "$AGENT_TOKEN" ]; then
            echo "‚ùå Failed to obtain agent access token"
            exit 1
          fi
          echo "AGENT_TOKEN=$AGENT_TOKEN" >> $GITHUB_ENV
          echo "AGENT_ID=$AGENT_ID" >> $GITHUB_ENV

          echo "‚úÖ Auth setup complete. Admin and Agent tokens exported."

      - name: Test health endpoint
        run: |
          echo "üè• Testing /api/availability/health endpoint..."
          HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/availability/health)
          HEALTH_CODE=$(echo "$HEALTH_RESPONSE" | tail -n1)
          HEALTH_BODY=$(echo "$HEALTH_RESPONSE" | head -n-1)
          echo "Health Status: $HEALTH_CODE"
          echo "Health Body: $HEALTH_BODY"
          if [ "$HEALTH_CODE" != "200" ]; then
            echo "‚ùå Health check failed with status $HEALTH_CODE"
            exit 1
          fi
          echo "‚úÖ Health check passed"

      - name: Test Supabase connectivity
        run: |
          echo "üîó Testing Supabase connection..."
          # Use PostgREST to execute a lightweight query (SELECT NOW())
          SUPABASE_URL="${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}"
          SUPABASE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          # Query a simple RPC or use PostgREST to verify connection
          # For simplicity, we'll query the agent_availability table with a limit 0 (no data returned, just tests connection)
          CONN_RESPONSE=$(curl -s -w "\n%{http_code}" "${SUPABASE_URL}/rest/v1/agent_availability?limit=0" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}")
          CONN_CODE=$(echo "$CONN_RESPONSE" | tail -n1)
          echo "Supabase connectivity status: $CONN_CODE"
          if [ "$CONN_CODE" != "200" ]; then
            echo "‚ùå Supabase connectivity check failed with status $CONN_CODE"
            echo "Response: $(echo "$CONN_RESPONSE" | head -n-1)"
            exit 1
          fi
          echo "‚úÖ Supabase connection verified"

      - name: Test API endpoint directly with curl
        run: |
          echo "üß™ Testing POST to /api/availability with curl..."
          # Add extra stability check before curl test
          sleep 3
          wait-on tcp:3000 --timeout 10000
          # Build a unique, schema-valid payload to avoid collisions with any unique constraints
          DATE=$(date -u +%F)
          START_MIN=$(printf "%02d" $((RANDOM % 60)))
          END_MIN=$(printf "%02d" $(((10 + RANDOM) % 60)))
          START="10:${START_MIN}:00"
          END="16:${END_MIN}:00"
          NAME="CI Test ${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          PAYLOAD=$(printf '{"agent_name":"%s","availability_date":"%s","start_time":"%s","end_time":"%s","notes":null}' "${NAME}" "${DATE}" "${START}" "${END}")
          echo "Using payload: $PAYLOAD"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/availability \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${AGENT_TOKEN}" \
            -d "$PAYLOAD")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"
          if [ "$HTTP_CODE" != "201" ]; then
            echo "‚ùå Expected 201, got $HTTP_CODE"
            echo "Response: $BODY"
            echo "---- .next.log (tail) ----"
            [ -f .next.log ] && tail -n 200 .next.log || echo "No .next.log found"
            exit 1
          fi
          echo "‚úÖ Direct API test passed"

      - name: Test Assignments POST endpoint
        run: |
          echo "üß™ Testing POST to /api/assignments with curl..."
          # Generate random UUIDs for agent_id and shift_id
          AGENT_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
          SHIFT_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
          STATUS="assigned"
          NOTES="CI Test Assignment ${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          PAYLOAD=$(printf '{"agent_id":"%s","shift_id":"%s","status":"%s","notes":"%s"}' "${AGENT_ID}" "${SHIFT_ID}" "${STATUS}" "${NOTES}")
          echo "Using payload: $PAYLOAD"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/assignments \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "$PAYLOAD")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"
          if [ "$HTTP_CODE" != "201" ]; then
            echo "‚ùå Expected 201, got $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
          echo "‚úÖ Assignments POST test passed"

      - name: Test Assignments GET endpoint
        run: |
          echo "üß™ Testing GET /api/assignments..."
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/assignments \
            -H "Authorization: Bearer ${ADMIN_TOKEN}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body (truncated): $(echo "$BODY" | head -c 500)"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Expected 200, got $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ Assignments GET test passed"

      - name: Test Dashboard endpoint
        run: |
          echo "üìä Testing GET /api/dashboard..."
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/dashboard)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body (truncated): $(echo "$BODY" | head -c 500)"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Expected 200, got $HTTP_CODE"
            exit 1
          fi
          # Verify response has expected structure (success and data fields)
          if echo "$BODY" | grep -q '"success":true' && echo "$BODY" | grep -q '"data"'; then
            echo "‚úÖ Dashboard endpoint test passed with valid structure"
          else
            echo "‚ùå Response missing expected fields (success, data)"
            exit 1
          fi

      - name: Dashboard Charts Render Test (allow redirect if protected)
        run: |
          echo "üìà Testing Dashboard page with charts..."
          # Test that the dashboard page loads successfully
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:3000/dashboard)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          echo "HTTP Status: $HTTP_CODE"
          # Accept 200 (rendered) or 30x (redirect to signin) depending on middleware state
          case "$HTTP_CODE" in
            200|301|302|307|308)
              echo "‚úÖ Dashboard page reachable (HTTP $HTTP_CODE)" ;;
            *)
              echo "‚ùå Dashboard page unexpected status $HTTP_CODE" ; exit 1 ;;
          esac
          # Verify the page contains dashboard elements (basic HTML structure check)
          if echo "$BODY" | grep -qi "dashboard" || echo "$BODY" | grep -qi "availability"; then
            echo "‚úÖ Dashboard page rendered successfully"
          else
            echo "‚ö†Ô∏è  Dashboard page loaded but content validation inconclusive"
          fi

      - name: Agents API CRUD Tests
        run: |
          echo "üë§ Testing Agents API CRUD operations..."
          
          # POST - Create agent (expect 201)
          echo "Testing POST /api/agents..."
          AGENT_PAYLOAD=$(cat <<EOF
          {
            "name": "Test Agent ${{ github.run_id }}",
            "email": "agent-${{ github.run_id }}@test.com",
            "role": "Support Agent",
            "status": "active"
          }
          EOF
          )
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/agents \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "$AGENT_PAYLOAD")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          echo "POST Response: $BODY"
          if [ "$HTTP_CODE" != "201" ]; then
            echo "‚ùå POST failed, expected 201, got $HTTP_CODE"
            exit 1
          fi
          AGENT_ID=$(echo "$BODY" | grep -o '"id":"[^"]*"' | head -n1 | cut -d'"' -f4)
          echo "Created agent with ID: $AGENT_ID"
          
          # GET - List agents (expect 200)
          echo "Testing GET /api/agents..."
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/agents \
            -H "Authorization: Bearer ${ADMIN_TOKEN}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå GET failed, expected 200, got $HTTP_CODE"
            exit 1
          fi
          
          # PUT - Update agent (expect 200)
          echo "Testing PUT /api/agents..."
          UPDATE_PAYLOAD=$(cat <<EOF
          {
            "id": "$AGENT_ID",
            "status": "inactive"
          }
          EOF
          )
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT http://localhost:3000/api/agents \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "$UPDATE_PAYLOAD")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          echo "PUT Response: $BODY"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå PUT failed, expected 200, got $HTTP_CODE"
            exit 1
          fi
          
          # DELETE - Remove agent (expect 204)
          echo "Testing DELETE /api/agents..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE "http://localhost:3000/api/agents?id=$AGENT_ID" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}")
          if [ "$HTTP_CODE" != "204" ]; then
            echo "‚ùå DELETE failed, expected 204, got $HTTP_CODE"
            exit 1
          fi
          
          echo "‚úÖ Agents API CRUD tests passed"

      - name: Shifts API CRUD Tests
        run: |
          echo "üìÖ Testing Shifts API CRUD operations..."
          
          # POST - Create shift (expect 201)
          echo "Testing POST /api/shifts..."
          SHIFT_PAYLOAD=$(cat <<EOF
          {
            "date": "2025-11-15",
            "start_time": "09:00",
            "end_time": "17:00",
            "location": "Office Building A",
            "notes": "CI Test Shift ${{ github.run_id }}"
          }
          EOF
          )
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/shifts \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "$SHIFT_PAYLOAD")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          echo "POST Response: $BODY"
          if [ "$HTTP_CODE" != "201" ]; then
            echo "‚ùå POST failed, expected 201, got $HTTP_CODE"
            exit 1
          fi
          SHIFT_ID=$(echo "$BODY" | grep -o '"id":"[^"]*"' | head -n1 | cut -d'"' -f4)
          echo "Created shift with ID: $SHIFT_ID"
          
          # GET - List shifts (expect 200)
          echo "Testing GET /api/shifts..."
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/shifts \
            -H "Authorization: Bearer ${ADMIN_TOKEN}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå GET failed, expected 200, got $HTTP_CODE"
            exit 1
          fi
          
          # PUT - Update shift (expect 200)
          echo "Testing PUT /api/shifts..."
          UPDATE_PAYLOAD=$(cat <<EOF
          {
            "id": "$SHIFT_ID",
            "location": "Office Building B"
          }
          EOF
          )
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT http://localhost:3000/api/shifts \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "$UPDATE_PAYLOAD")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          echo "PUT Response: $BODY"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå PUT failed, expected 200, got $HTTP_CODE"
            exit 1
          fi
          
          # DELETE - Remove shift (expect 204)
          echo "Testing DELETE /api/shifts..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE "http://localhost:3000/api/shifts?id=$SHIFT_ID" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}")
          if [ "$HTTP_CODE" != "204" ]; then
            echo "‚ùå DELETE failed, expected 204, got $HTTP_CODE"
            exit 1
          fi
          
          echo "‚úÖ Shifts API CRUD tests passed"

      - name: Realtime Connectivity Test
        run: |
          echo "üì° Testing Supabase Realtime connectivity..."
          
          # Insert a test record into agent_availability to trigger realtime event
          echo "Inserting test availability record to trigger realtime event..."
          REALTIME_PAYLOAD=$(cat <<EOF
          {
            "agent_name": "Realtime Test Agent ${{ github.run_id }}",
            "availability_date": "2025-11-20",
            "start_time": "10:00",
            "end_time": "18:00",
            "notes": "Realtime connectivity test"
          }
          EOF
          )
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/availability \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "$REALTIME_PAYLOAD")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" != "201" ]; then
            echo "‚ùå Failed to insert realtime test record, got HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
          
          echo "‚úÖ Realtime test record inserted successfully"
          echo "üì° Realtime event should be logged in browser console when dashboard is open"
          echo "Note: CI validates realtime channel setup via successful insert"
          
          # Verify the record was created via GET
          echo "Verifying record via GET /api/availability..."
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/availability \
            -H "Authorization: Bearer ${ADMIN_TOKEN}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå GET verification failed, got HTTP $HTTP_CODE"
            exit 1
          fi
          
          if echo "$BODY" | grep -q "Realtime Test Agent"; then
            echo "‚úÖ Realtime Connectivity Test passed - record verified"
          else
            echo "‚ö†Ô∏è  Record inserted but not found in GET response (may be timing issue)"
          fi

      - name: Stage 12 ‚Äì Auth & RBAC Tests
        run: |
          echo "üîê Stage 12: Auth & RBAC behavioral checks..."
          echo "0) Unauthenticated GET /dashboard should redirect to /signin"
          UNAUTH_HEADERS=$(curl -s -D - -o /dev/null http://localhost:3000/dashboard)
          echo "$UNAUTH_HEADERS" | grep -qi "^location: .*signin" || (echo "‚ùå Expected redirect to /signin for unauthenticated" && exit 1)

          echo "1) Admin can GET /api/agents (expect 200)"
          ADMIN_GET=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/agents \
            -H "Authorization: Bearer ${ADMIN_TOKEN}")
          ADMIN_CODE=$(echo "$ADMIN_GET" | tail -n1)
          if [ "$ADMIN_CODE" != "200" ]; then
            echo "‚ùå Admin GET /api/agents expected 200, got $ADMIN_CODE"; exit 1; fi

          echo "2) Agent forbidden on GET /api/agents (expect 403)"
          AGENT_GET=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/agents \
            -H "Authorization: Bearer ${AGENT_TOKEN}")
          AGENT_CODE=$(echo "$AGENT_GET" | tail -n1)
          if [ "$AGENT_CODE" != "403" ]; then
            echo "‚ùå Agent GET /api/agents expected 403, got $AGENT_CODE"; exit 1; fi

          echo "3) Agent can POST /api/availability (expect 201)"
          NOWDATE=$(date -u +%F)
          AV_PAYLOAD=$(printf '{"agent_name":"RBAC Agent","availability_date":"%s","start_time":"08:00","end_time":"12:00"}' "$NOWDATE")
          AV_POST=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/availability \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${AGENT_TOKEN}" \
            -d "$AV_PAYLOAD")
          AV_CODE=$(echo "$AV_POST" | tail -n1)
          if [ "$AV_CODE" != "201" ]; then
            echo "‚ùå Agent POST /api/availability expected 201, got $AV_CODE"; exit 1; fi

          echo "4) Unauthenticated POST /api/assignments blocked (expect 401/403)"
          ASG_PAYLOAD='{"agent_id":"00000000-0000-0000-0000-000000000000","shift_id":"00000000-0000-0000-0000-000000000000","status":"assigned"}'
          UNAUTH=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:3000/api/assignments \
            -H "Content-Type: application/json" \
            -d "$ASG_PAYLOAD")
          case "$UNAUTH" in
            401|403) echo "‚úÖ Unauthenticated request correctly blocked (HTTP $UNAUTH)" ;;
            *) echo "‚ùå Expected 401/403 for unauthenticated, got $UNAUTH"; exit 1 ;;
          esac

          echo "5) Agent page access: /availability allowed, /dashboard denied"
          # Provide session to middleware via sb-access-token cookie
          AV_PAGE_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/availability \
            -H "Cookie: sb-access-token=${AGENT_TOKEN}")
          if [ "$AV_PAGE_CODE" != "200" ]; then
            echo "‚ùå Agent should access /availability page, got $AV_PAGE_CODE"; exit 1; fi
          DASH_HEADERS=$(curl -s -D - -o /dev/null http://localhost:3000/dashboard \
            -H "Cookie: sb-access-token=${AGENT_TOKEN}")
          echo "$DASH_HEADERS" | grep -qi "^location: .*signin" || (echo "‚ùå Agent should be redirected away from /dashboard" && exit 1)

          echo "6) Admin can access protected pages"
          for PATH in \
            "/dashboard" \
            "/agents" \
            "/shifts" \
            "/settings/users"; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3000${PATH}" \
              -H "Cookie: sb-access-token=${ADMIN_TOKEN}")
            if [ "$CODE" != "200" ]; then
              echo "‚ùå Admin GET ${PATH} expected 200, got $CODE"; exit 1; fi
          done

          echo "‚úÖ Stage 12 Auth & RBAC tests passed"

      - name: Stage 13 ‚Äì Agent Portal & Respond Flow
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_ANON: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üë§ Stage 13: Verify /agent/dashboard access with agent cookie"
          CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/agent/dashboard \
            -H "Cookie: sb-access-token=${AGENT_TOKEN}")
          if [ "$CODE" != "200" ]; then
            echo "‚ùå /agent/dashboard expected 200, got $CODE"; exit 1; fi

          echo "üìå Create an assignment for the agent (admin)"
          SHIFT_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
          ASSIGN_PAYLOAD=$(printf '{"agent_id":"%s","shift_id":"%s","status":"assigned"}' "${AGENT_ID}" "${SHIFT_ID}")
          CREATE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/assignments \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "$ASSIGN_PAYLOAD")
          C_CODE=$(echo "$CREATE" | tail -n1)
          C_BODY=$(echo "$CREATE" | head -n-1)
          if [ "$C_CODE" != "201" ]; then
            echo "‚ùå Failed to create assignment, HTTP $C_CODE"; echo "$C_BODY"; exit 1; fi
          ASSIGNMENT_ID=$(echo "$C_BODY" | sed -n 's/.*"id":"\([^"]*\)".*/\1/p')
          if [ -z "$ASSIGNMENT_ID" ]; then echo "‚ùå Could not parse assignment id"; echo "$C_BODY"; exit 1; fi

          echo "‚úÖ Assignment created: $ASSIGNMENT_ID"
          echo "üü¢ Agent responds ACCEPT to assignment"
          RESPOND=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/assignments/respond \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${AGENT_TOKEN}" \
            -d "{\"assignment_id\":\"${ASSIGNMENT_ID}\",\"action\":\"accept\"}")
          R_CODE=$(echo "$RESPOND" | tail -n1)
          R_BODY=$(echo "$RESPOND" | head -n-1)
          if [ "$R_CODE" != "200" ]; then
            echo "‚ùå Agent respond expected 200, got $R_CODE"; echo "$R_BODY"; exit 1; fi

          echo "‚è±Ô∏è  Verifying status via Supabase REST (wait up to 2s)"
          TARGET_URL="${SUPABASE_URL}/rest/v1/assignments?id=eq.${ASSIGNMENT_ID}&select=id,status"
          for i in 1 2 3 4; do
            S=$(curl -s "$TARGET_URL" -H "apikey: ${SUPABASE_ANON}" -H "Authorization: Bearer ${SUPABASE_SERVICE}")
            STATUS=$(echo "$S" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')
            if [ "$STATUS" = "accepted" ]; then
              echo "‚úÖ Assignment status updated to 'accepted'"; FOUND=1; break; fi
            sleep 0.5
          done
          if [ "${FOUND:-0}" != "1" ]; then
            echo "‚ùå Assignment status did not update to 'accepted' in time"; echo "$S"; exit 1; fi

          echo "‚úÖ Stage 13 Agent Portal tests passed"

      - name: Stage 14 ‚Äì Messaging Automation Tests
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_ANON: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NOTIFICATIONS_MOCK: '1'
          WEBHOOK_SECRET: 'ci-secret'
        run: |
          echo "üì£ Stage 14: Messaging send and webhook response"
          # Create assignment for agent
          SHIFT2_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
          MAKE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/assignments \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "{\"agent_id\":\"${AGENT_ID}\",\"shift_id\":\"${SHIFT2_ID}\",\"status\":\"assigned\"}")
          M_CODE=$(echo "$MAKE" | tail -n1)
          M_BODY=$(echo "$MAKE" | head -n-1)
          if [ "$M_CODE" != "201" ]; then echo "‚ùå Create assignment failed"; echo "$M_BODY"; exit 1; fi
          AID=$(echo "$M_BODY" | sed -n 's/.*"id":"\([^"]*\)".*/\1/p')
          echo "Assignment: $AID"

          echo "‚û°Ô∏è  Send notification (mock providers)"
          SEND=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/notifications/send \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "{\"agent_id\":\"${AGENT_ID}\",\"shift_id\":\"${SHIFT2_ID}\",\"channel\":\"sms\",\"message\":\"New shift assigned\"}")
          S_CODE=$(echo "$SEND" | tail -n1)
          S_BODY=$(echo "$SEND" | head -n-1)
          echo "Send code: $S_CODE Body: $S_BODY"
          if [ "$S_CODE" != "200" ]; then echo "‚ùå Notification send failed"; exit 1; fi

          echo "üì• Simulate webhook response: YES -> accept"
          RESP=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/assignments/respond \
            -H "Content-Type: application/json" \
            -d "{\"webhook_secret\":\"${WEBHOOK_SECRET}\",\"assignment_id\":\"${AID}\",\"body\":\"YES\"}")
          R_CODE=$(echo "$RESP" | tail -n1)
          if [ "$R_CODE" != "200" ]; then echo "‚ùå Webhook respond failed ($R_CODE)"; echo "$RESP"; exit 1; fi

          echo "üîé Verify status becomes accepted within 3s"
          TARGET="${SUPABASE_URL}/rest/v1/assignments?id=eq.${AID}&select=id,status"
          for i in 1 2 3 4 5 6; do
            OUT=$(curl -s "$TARGET" -H "apikey: ${SUPABASE_ANON}" -H "Authorization: Bearer ${SUPABASE_SERVICE}")
            STATUS=$(echo "$OUT" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p')
            if [ "$STATUS" = "accepted" ]; then echo "‚úÖ Accepted confirmed"; OK=1; break; fi
            sleep 0.5
          done
          if [ "${OK:-0}" != "1" ]; then echo "‚ùå Status not accepted in time"; echo "$OUT"; exit 1; fi

          echo "‚úÖ Stage 14 messaging tests passed"

      - name: Stage 15 ‚Äì Multi-Org Tests
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_ANON: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üè¢ Stage 15: Multi-Org setup and validation"

          # Create a manager user
          MANAGER_EMAIL="manager-${{ github.run_id }}@ci.test"
          PASSWORD="P@ss-${{ github.run_id }}"
          M_CREATE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/auth/create-test-user \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"${MANAGER_EMAIL}\",\"password\":\"${PASSWORD}\"}")
          M_CODE=$(echo "$M_CREATE" | tail -n1)
          M_BODY=$(echo "$M_CREATE" | head -n-1)
          if [ "$M_CODE" != "201" ]; then echo "‚ùå create manager failed"; echo "$M_BODY"; exit 1; fi
          MANAGER_ID=$(echo "$M_BODY" | sed -n 's/.*"id":"\([^"]*\)".*/\1/p')

          # Assign manager role
          curl -s -X POST "${SUPABASE_URL}/rest/v1/user_roles?on_conflict=user_id" \
            -H "apikey: ${SUPABASE_SERVICE}" -H "Authorization: Bearer ${SUPABASE_SERVICE}" \
            -H "Content-Type: application/json" -H "Prefer: resolution=merge-duplicates,return=minimal" \
            -d "[{\"user_id\":\"${MANAGER_ID}\",\"role\":\"manager\"}]" >/dev/null

          # Get manager token
          M_TOKEN=$(curl -s -X POST "${SUPABASE_URL}/auth/v1/token?grant_type=password" \
            -H "apikey: ${SUPABASE_ANON}" -H "Content-Type: application/json" \
            -d "{\"email\":\"${MANAGER_EMAIL}\",\"password\":\"${PASSWORD}\"}" | sed -n 's/.*"access_token":"\([^"]*\)".*/\1/p')
          if [ -z "$M_TOKEN" ]; then echo "‚ùå manager token missing"; exit 1; fi
          echo "M_TOKEN=$M_TOKEN" >> $GITHUB_ENV

          echo "‚ûï Create organization (admin)"
          ORG_CREATE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/organizations \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "{\"name\":\"Org ${{ github.run_id }}\",\"manager_user_id\":\"${MANAGER_ID}\"}")
          O_CODE=$(echo "$ORG_CREATE" | tail -n1)
          O_BODY=$(echo "$ORG_CREATE" | head -n-1)
          if [ "$O_CODE" != "201" ]; then echo "‚ùå create org failed"; echo "$O_BODY"; exit 1; fi
          ORG_ID=$(echo "$O_BODY" | sed -n 's/.*"id":"\([^"]*\)".*/\1/p')

          echo "üë§ Create org agent user"
          ORG_AGENT_EMAIL="org-agent-${{ github.run_id }}@ci.test"
          OA_CREATE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/auth/create-test-user \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"${ORG_AGENT_EMAIL}\",\"password\":\"${PASSWORD}\"}")
          OA_CODE=$(echo "$OA_CREATE" | tail -n1)
          OA_BODY=$(echo "$OA_CREATE" | head -n-1)
          if [ "$OA_CODE" != "201" ]; then echo "‚ùå create org agent user failed"; echo "$OA_BODY"; exit 1; fi
          ORG_AGENT_ID=$(echo "$OA_BODY" | sed -n 's/.*"id":"\([^"]*\)".*/\1/p')

          echo "‚ûï Add manager and agent membership to org"
          curl -s -X POST http://localhost:3000/api/organizations/members \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "{\"organization_id\":\"${ORG_ID}\",\"user_id\":\"${MANAGER_ID}\",\"role\":\"manager\"}" >/dev/null
          curl -s -X POST http://localhost:3000/api/organizations/members \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d "{\"organization_id\":\"${ORG_ID}\",\"user_id\":\"${ORG_AGENT_ID}\",\"role\":\"agent\"}" >/dev/null

          echo "üìä Manager can access /org/dashboard"
          CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/org/dashboard \
            -H "Cookie: sb-access-token=${M_TOKEN}")
          if [ "$CODE" != "200" ]; then echo "‚ùå /org/dashboard expected 200, got $CODE"; exit 1; fi

          echo "üóìÔ∏è  Manager creates org shift"
          S_CREATE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/org/shifts \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${M_TOKEN}" \
            -d '{"date":"2025-12-01","start_time":"09:00","end_time":"17:00","location":"HQ"}')
          S_CODE=$(echo "$S_CREATE" | tail -n1)
          if [ "$S_CODE" != "201" ]; then echo "‚ùå org shift create failed"; echo "$S_CREATE"; exit 1; fi

          echo "üë• Manager roster lists only org agents"
          ROSTER=$(curl -s http://localhost:3000/api/org/roster -H "Authorization: Bearer ${M_TOKEN}")
          echo "$ROSTER" | grep -q "$ORG_AGENT_ID" || (echo "‚ùå org roster missing org agent"; exit 1)

          echo "ü§ù Manager requests shared agent"
          SHARED_AGENT_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
          REQ=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/org/request-shared \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${M_TOKEN}" \
            -d "{\"shift_id\":\"dummy-shift\",\"agent_id\":\"${SHARED_AGENT_ID}\"}")
          REQ_CODE=$(echo "$REQ" | tail -n1)
          if [ "$REQ_CODE" != "201" ]; then echo "‚ùå request-shared failed"; echo "$REQ"; exit 1; fi

          echo "üß≠ Admin lists organizations"
          ORGS=$(curl -s http://localhost:3000/api/organizations -H "Authorization: Bearer ${ADMIN_TOKEN}")
          echo "$ORGS" | grep -q "$ORG_ID" || (echo "‚ùå admin did not see created org"; exit 1)

          echo "‚úÖ Stage 15 Multi-Org tests passed"

      - name: Stage 16 ‚Äì Analytics & Reporting Tests
        env:
          ANALYTICS_MOCK: '1'
        run: |
          echo "üìä Stage 16: Hitting analytics endpoints with mock data"
          echo "‚Üí GET /api/analytics/summary as ADMIN"
          S1=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/analytics/summary \
            -H "Authorization: Bearer ${ADMIN_TOKEN}")
          C1=$(echo "$S1" | tail -n1)
          B1=$(echo "$S1" | head -n-1)
          if [ "$C1" != "200" ]; then echo "‚ùå summary as admin failed ($C1)"; echo "$B1"; exit 1; fi
          echo "$B1" | grep -q 'total_agents' || (echo "‚ùå missing total_agents"; exit 1)
          echo "$B1" | grep -q 'accepted_vs_declined' || (echo "‚ùå missing accepted_vs_declined"; exit 1)

          echo "‚Üí GET /api/analytics/timeseries as ADMIN"
          T1=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/analytics/timeseries \
            -H "Authorization: Bearer ${ADMIN_TOKEN}")
          CT1=$(echo "$T1" | tail -n1)
          BT1=$(echo "$T1" | head -n-1)
          if [ "$CT1" != "200" ]; then echo "‚ùå timeseries as admin failed ($CT1)"; echo "$BT1"; exit 1; fi
          echo "$BT1" | grep -q 'dates' || (echo "‚ùå missing dates"; exit 1)
          echo "$BT1" | grep -q 'requests' || (echo "‚ùå missing requests"; exit 1)

          echo "‚Üí GET /api/analytics/summary as MANAGER"
          S2=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/analytics/summary \
            -H "Authorization: Bearer ${M_TOKEN}")
          C2=$(echo "$S2" | tail -n1)
          if [ "$C2" != "200" ]; then echo "‚ùå summary as manager failed ($C2)"; echo "$S2"; exit 1; fi

          echo "‚Üí GET /api/analytics/timeseries as MANAGER"
          T2=$(curl -s -w "\n%{http_code}" http://localhost:3000/api/analytics/timeseries \
            -H "Authorization: Bearer ${M_TOKEN}")
          CT2=$(echo "$T2" | tail -n1)
          if [ "$CT2" != "200" ]; then echo "‚ùå timeseries as manager failed ($CT2)"; echo "$T2"; exit 1; fi

          echo "‚Üí Page render: /analytics as ADMIN"
          PC=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/analytics \
            -H "Cookie: sb-access-token=${ADMIN_TOKEN}")
          if [ "$PC" != "200" ]; then echo "‚ùå /analytics expected 200, got $PC"; exit 1; fi

          echo "‚úÖ Stage 16 analytics tests passed"

      - name: Stage 17 ‚Äì Deployment Readiness Check
        run: |
          echo "üöÄ Stage 17: Verifying deployment readiness"
          
          echo "‚Üí Check deployment artifacts exist"
          if [ ! -d ".next" ]; then
            echo "‚ùå .next build directory missing"
            exit 1
          fi
          
          echo "‚Üí Verify production build completed"
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "‚ùå BUILD_ID missing - production build incomplete"
            exit 1
          fi
          
          BUILD_ID=$(cat .next/BUILD_ID)
          echo "‚úÖ Build ID: $BUILD_ID"
          
          echo "‚Üí Check required routes are built"
          ROUTES=("dashboard" "analytics" "agents" "shifts" "assignments")
          for ROUTE in "${ROUTES[@]}"; do
            if [ ! -d ".next/server/app/(admin)/${ROUTE}" ]; then
              echo "‚ö†Ô∏è  Warning: Route ${ROUTE} may not be built"
            else
              echo "‚úÖ Route ${ROUTE} built"
            fi
          done
          
          echo "‚Üí Verify API routes are present"
          if [ ! -d ".next/server/app/api" ]; then
            echo "‚ùå API routes directory missing"
            exit 1
          fi
          echo "‚úÖ API routes present"
          
          echo "‚Üí Check static assets"
          if [ ! -d ".next/static" ]; then
            echo "‚ùå Static assets missing"
            exit 1
          fi
          echo "‚úÖ Static assets generated"
          
          echo "‚Üí Deployment summary"
          echo "üì¶ Build artifacts ready for Vercel deployment"
          echo "üìä Total build size: $(du -sh .next | cut -f1)"
          echo "üî¢ API endpoints: $(find .next/server/app/api -name 'route.js' 2>/dev/null | wc -l)"
          echo "üìÑ Pages: $(find .next/server/app -name 'page.js' 2>/dev/null | wc -l)"
          
          # Add deployment summary to GitHub Actions summary
          echo "## üöÄ Deployment Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build ID:** \`$BUILD_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build Size:** $(du -sh .next | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "**API Endpoints:** $(find .next/server/app/api -name 'route.js' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "**Pages Built:** $(find .next/server/app -name 'page.js' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Deployment Prerequisites" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Production build completed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Static assets generated" >> $GITHUB_STEP_SUMMARY
          echo "- [x] API routes built" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Pages rendered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Tag this commit with \`v1.0.x\` to trigger automatic Vercel deployment." >> $GITHUB_STEP_SUMMARY
          
          echo "‚úÖ Stage 17 deployment readiness check passed"

      - name: Stage 18 ‚Äì AI Assistant Smoke Test
        env:
          AI_ASSISTANT_MOCK: '1'
        run: |
          echo "ü§ñ Stage 18: AI Assistant endpoint tests"
          
          echo "‚Üí POST /api/ai/assistant as ADMIN (analytics query)"
          A1=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/ai/assistant \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d '{"query":"How do I view analytics?","role":"admin"}')
          A1_CODE=$(echo "$A1" | tail -n1)
          A1_BODY=$(echo "$A1" | head -n-1)
          if [ "$A1_CODE" != "200" ]; then echo "‚ùå AI assistant as admin failed ($A1_CODE)"; echo "$A1_BODY"; exit 1; fi
          echo "$A1_BODY" | grep -q 'response' || (echo "‚ùå missing response field"; exit 1)
          echo "$A1_BODY" | grep -qi 'analytics' || (echo "‚ùå response missing analytics guidance"; exit 1)
          
          echo "‚Üí POST /api/ai/assistant as MANAGER (org query)"
          M1=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/ai/assistant \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${M_TOKEN}" \
            -d '{"query":"How do I manage my roster?","role":"manager"}')
          M1_CODE=$(echo "$M1" | tail -n1)
          M1_BODY=$(echo "$M1" | head -n-1)
          if [ "$M1_CODE" != "200" ]; then echo "‚ùå AI assistant as manager failed ($M1_CODE)"; echo "$M1_BODY"; exit 1; fi
          echo "$M1_BODY" | grep -q 'response' || (echo "‚ùå missing response field"; exit 1)
          echo "$M1_BODY" | grep -qi 'roster\|organization' || (echo "‚ùå response missing org guidance"; exit 1)
          
          echo "‚Üí POST /api/ai/assistant as AGENT (assignment query)"
          AG1=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/ai/assistant \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${AGENT_TOKEN}" \
            -d '{"query":"How do I accept a shift?","role":"agent"}')
          AG1_CODE=$(echo "$AG1" | tail -n1)
          AG1_BODY=$(echo "$AG1" | head -n-1)
          if [ "$AG1_CODE" != "200" ]; then echo "‚ùå AI assistant as agent failed ($AG1_CODE)"; echo "$AG1_BODY"; exit 1; fi
          echo "$AG1_BODY" | grep -q 'response' || (echo "‚ùå missing response field"; exit 1)
          echo "$AG1_BODY" | grep -qi 'accept\|assignment\|shift' || (echo "‚ùå response missing assignment guidance"; exit 1)
          
          echo "‚Üí Verify role-specific responses differ"
          if [ "$A1_BODY" = "$M1_BODY" ] || [ "$A1_BODY" = "$AG1_BODY" ] || [ "$M1_BODY" = "$AG1_BODY" ]; then
            echo "‚ö†Ô∏è  Warning: Role-specific responses may be too similar"
          else
            echo "‚úÖ Role-specific responses are distinct"
          fi
          
          echo "‚Üí Test unauthorized access (no token)"
          UNAUTH=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:3000/api/ai/assistant \
            -H "Content-Type: application/json" \
            -d '{"query":"test"}')
          if [ "$UNAUTH" != "401" ] && [ "$UNAUTH" != "403" ]; then
            echo "‚ùå Unauthorized access should return 401/403, got $UNAUTH"
            exit 1
          fi
          echo "‚úÖ Unauthorized access properly blocked"
          
          echo "‚úÖ Stage 18 AI Assistant tests passed"

      - name: Stage 19 ‚Äì AI Action Automation Test
        env:
          AI_ASSISTANT_MOCK: '1'
        run: |
          echo "‚ö° Stage 19: AI action automation and intelligent routing tests"
          
          echo "‚Üí POST /api/ai/assistant with 'create shift' intent (admin)"
          CS1=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/ai/assistant \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d '{"query":"Create a shift tomorrow 9-5","role":"admin"}')
          CS1_CODE=$(echo "$CS1" | tail -n1)
          CS1_BODY=$(echo "$CS1" | head -n-1)
          if [ "$CS1_CODE" != "200" ]; then echo "‚ùå Create shift intent failed ($CS1_CODE)"; echo "$CS1_BODY"; exit 1; fi
          echo "$CS1_BODY" | grep -q '"action"' || (echo "‚ùå missing action field"; exit 1)
          echo "$CS1_BODY" | grep -q 'create_shift' || (echo "‚ùå action should be create_shift"; exit 1)
          echo "$CS1_BODY" | grep -qi 'shift created\|created successfully' || (echo "‚ùå response missing success confirmation"; exit 1)
          echo "‚úÖ Create shift action executed successfully"
          
          echo "‚Üí POST /api/ai/assistant with 'assign agent' intent (manager)"
          AA1=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/ai/assistant \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${M_TOKEN}" \
            -d '{"query":"Assign agent John to the next shift","role":"manager"}')
          AA1_CODE=$(echo "$AA1" | tail -n1)
          AA1_BODY=$(echo "$AA1" | head -n-1)
          if [ "$AA1_CODE" != "200" ]; then echo "‚ùå Assign agent intent failed ($AA1_CODE)"; echo "$AA1_BODY"; exit 1; fi
          echo "$AA1_BODY" | grep -q '"action"' || (echo "‚ùå missing action field"; exit 1)
          echo "$AA1_BODY" | grep -q 'assign_agent' || (echo "‚ùå action should be assign_agent"; exit 1)
          echo "$AA1_BODY" | grep -qi 'assigned\|assignment' || (echo "‚ùå response missing assignment confirmation"; exit 1)
          echo "‚úÖ Assign agent action executed successfully"
          
          echo "‚Üí POST /api/ai/assistant with 'show analytics' intent (admin)"
          SA1=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/ai/assistant \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d '{"query":"Show analytics summary","role":"admin"}')
          SA1_CODE=$(echo "$SA1" | tail -n1)
          SA1_BODY=$(echo "$SA1" | head -n-1)
          if [ "$SA1_CODE" != "200" ]; then echo "‚ùå Show analytics intent failed ($SA1_CODE)"; echo "$SA1_BODY"; exit 1; fi
          echo "$SA1_BODY" | grep -q '"action"' || (echo "‚ùå missing action field"; exit 1)
          echo "$SA1_BODY" | grep -q 'show_analytics' || (echo "‚ùå action should be show_analytics"; exit 1)
          echo "$SA1_BODY" | grep -qi 'performance\|fill rate\|agents' || (echo "‚ùå response missing analytics data"; exit 1)
          echo "‚úÖ Show analytics action executed successfully"
          
          echo "‚Üí POST /api/ai/assistant with 'notify agent' intent (dispatcher)"
          NA1=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/ai/assistant \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d '{"query":"Notify agent Sarah about the new shift","role":"dispatcher"}')
          NA1_CODE=$(echo "$NA1" | tail -n1)
          NA1_BODY=$(echo "$NA1" | head -n-1)
          if [ "$NA1_CODE" != "200" ]; then echo "‚ùå Notify agent intent failed ($NA1_CODE)"; echo "$NA1_BODY"; exit 1; fi
          echo "$NA1_BODY" | grep -q '"action"' || (echo "‚ùå missing action field"; exit 1)
          echo "$NA1_BODY" | grep -q 'notify_agent' || (echo "‚ùå action should be notify_agent"; exit 1)
          echo "$NA1_BODY" | grep -qi 'notification sent\|notified' || (echo "‚ùå response missing notification confirmation"; exit 1)
          echo "‚úÖ Notify agent action executed successfully"
          
          echo "‚Üí Verify agent role CANNOT execute write actions (RBAC enforcement)"
          AGENT_WRITE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/ai/assistant \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${AGENT_TOKEN}" \
            -d '{"query":"Create a shift tomorrow","role":"agent"}')
          AGENT_WRITE_CODE=$(echo "$AGENT_WRITE" | tail -n1)
          AGENT_WRITE_BODY=$(echo "$AGENT_WRITE" | head -n-1)
          
          # Agent should get 403 for write actions OR a message saying they don't have permission
          if [ "$AGENT_WRITE_CODE" = "403" ]; then
            echo "‚úÖ Agent properly blocked from write actions (403)"
          elif echo "$AGENT_WRITE_BODY" | grep -qi 'permission\|not authorized\|cannot'; then
            echo "‚úÖ Agent write action denied with permission message"
          else
            echo "‚ùå Agent should be blocked from executing write actions"
            echo "Response code: $AGENT_WRITE_CODE"
            echo "Response body: $AGENT_WRITE_BODY"
            exit 1
          fi
          
          echo "‚Üí Verify intent detection and action execution flow"
          echo "$CS1_BODY" | grep -q 'intent' || (echo "‚ö†Ô∏è  Warning: intent field may be missing from response")
          echo "$CS1_BODY" | grep -q 'confidence' || (echo "‚ö†Ô∏è  Warning: confidence field may be missing from response")
          echo "$CS1_BODY" | grep -q 'actionDetails' || (echo "‚ö†Ô∏è  Warning: actionDetails field may be missing from response")
          
          echo "‚Üí Test suggested actions are role-aware"
          SUGGEST=$(curl -s -X POST http://localhost:3000/api/ai/assistant \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -d '{"query":"Help me","role":"admin"}')
          echo "$SUGGEST" | grep -q 'suggestedActions\|suggested' && echo "‚úÖ Suggested actions present" || echo "‚ö†Ô∏è  No suggested actions in response"
          
          echo "‚úÖ Stage 19 AI Action Automation tests passed"

      - name: Run API integration tests
        env:
          AUTH_TOKEN: ${{ env.AGENT_TOKEN }}
        run: |
          echo "Running npm run test:api"
          # Small buffer to ensure server is fully warm after curl test
          sleep 2
          PORT=3000 npm run test:api

      - name: Show Next.js logs (if any)
        if: failure()
        run: |
          echo "---- .next.log (tail) ----"
          [ -f .next.log ] && tail -n 200 .next.log || echo "No .next.log found"
